# Configure log settings in Azure Monitor

## 1. Why logs matter

Metrics answer **“how much”** (CPU%, latency, IOPS).  
**Logs** answer **“what exactly happened”** (which request, which user, which rule).

Azure Monitor logs let you:

- Investigate failures and errors in detail.
- Audit who did what and when (operations, sign‑ins).
- Analyze security events.
- Build advanced alerts using KQL.
- Feed data to SIEM tools and long‑term archives.

In AZ‑104, you must know **where logs come from** and **how to configure log collection** using **diagnostic settings** and **Log Analytics workspaces**.

---

## 2. Types of logs in Azure

### 2.1 Activity log (control‑plane operations)

- **Scope:** Subscription level.
- Logs operations on Azure resources (create, update, delete), service health events, and some policy events.
- Example entries:
  - “Create virtual machine”
  - “Delete resource group”
  - “Role assignment added”
- Useful for:
  - Who did what?
  - Which operation failed and why?
  - Governance and auditing.

You can:
- View it in **Monitor → Activity log**.
- Export it with **diagnostic settings** to:
  - Log Analytics workspace
  - Storage account
  - Event Hub

### 2.2 Resource logs (data‑plane / internal operations)

- Generated by specific resources and services.
- Examples:
  - Key Vault logs (vault access, key operations).
  - Storage account logs (read/write/delete, authentication failures).
  - NSG flow logs (network flows allowed/denied).
  - Application Gateway access and performance logs.

Resource logs are **not** enabled by default.  
You must configure **diagnostic settings on each resource (or via policy)**.

### 2.3 Microsoft Entra ID (Azure AD) logs

- **Sign‑in logs:** who signed in, when, where, success/failure, conditional access results.
- **Audit logs:** changes to users, groups, applications, policies.
- **Provisioning logs, risk logs**, etc.

These logs live in Entra ID and can be:
- Viewed in **Entra admin center**.
- Sent to **Log Analytics workspace**, **Storage**, or **Event Hub** via diagnostic settings.

### 2.4 Guest OS and application logs

Collected from inside the VM or server using the **Azure Monitor Agent (AMA)**:

- Windows: Event logs, performance counters, IIS logs.
- Linux: Syslog, custom log files, performance metrics.
- Application logs (if configured).

These go to a **Log Analytics workspace**, according to **data collection rules (DCRs)**.

---

## 3. Log Analytics workspaces

A **Log Analytics workspace** is a special Azure resource that stores log data in tables.

Key points:

- Each workspace has:
  - **Tables** (AzureActivity, Heartbeat, Perf, SecurityEvent, etc.).
  - **Retention** settings (e.g., 30, 90, 365 days).
  - **Billing** based on volume of data ingested and stored.

- You can send logs from:
  - Activity log
  - Resource logs
  - Microsoft Entra ID logs
  - Azure Monitor Agent (VMs, servers)
  - Many Azure services and solutions (VM Insights, Container Insights, etc.)

**Best practices:**

- Use **central workspaces per environment** (Prod / Test / Dev), region, or business unit.
- Avoid too many small workspaces – harder to manage and query.
- Set **retention** according to business, compliance, and cost needs.
- Use **per‑table retention** if some tables must be kept longer.

---

## 4. Diagnostic settings – the key configuration

### 4.1 What is a diagnostic setting?

A **diagnostic setting** is a resource‑level configuration that tells Azure:

> “Which logs and metrics should this resource send, and where should they go?”

You can create diagnostic settings on:
- Individual resources (e.g., Storage account, Key Vault, NSG).
- Resource types at scale using **Azure Policy**.
- Subscriptions (for Activity log).
- Microsoft Entra ID (for sign‑in/audit logs).

### 4.2 Destinations

For most resources you can send logs to up to several destinations:

1. **Log Analytics workspace**
   - Best choice for interactive querying (KQL), alerts, workbooks, and dashboards.
   - Used by Azure Monitor Insights (VM, Network, etc.).

2. **Storage account**
   - Good for long‑term, low‑cost archive.
   - Not convenient for ad‑hoc queries without external tools.

3. **Event Hub**
   - Used to stream logs to external systems (third‑party SIEM, custom streaming apps).

4. **Partner solutions**
   - Some services can send logs directly to integrated partner tools.

**Exam tip:**  
If the question says:
- *“Run queries and alerts”* → send to **Log Analytics workspace**.  
- *“Long‑term archive for 7 years”* → send to **Storage account** (maybe along with workspace).  
- *“Forward to external SIEM”* → send to **Event Hub**.

### 4.3 Steps in the portal

Example: enable logs for a Key Vault.

1. Go to **Key Vault → Monitoring → Diagnostic settings**.
2. Click **Add diagnostic setting**.
3. Give it a **Name**.
4. Select **Log categories** (e.g., `AuditEvent`, `AllLogs`) and **metrics** if needed.
5. Choose one or more **Destinations**:
   - Send to Log Analytics workspace (select subscription + workspace).
   - Archive to storage account.
   - Stream to Event Hub.
6. Click **Save**.

The same pattern applies to many resources (Storage, Key Vault, App Gateway, VPN Gateway, etc.).

### 4.4 Diagnostic settings for Activity log

For the **subscription Activity log**:

1. Go to **Monitor → Activity log**.
2. Click **Export Activity Logs** or **Diagnostic settings**.
3. Create a setting, choose categories (Administrative, Security, ServiceHealth, etc.).
4. Select destination (workspace, storage, Event Hub).

This allows you to keep Activity log entries longer and query them with KQL.

---

## 5. Data Collection Rules (DCR) for Azure Monitor Agent

The **Azure Monitor Agent (AMA)** uses **Data Collection Rules (DCRs)** to control:

- What data to collect (performance counters, event logs, syslog, custom logs).
- Where to send the data (one or more Log Analytics workspaces, Metrics store).
- Filtering and transformations.

Key facts (exam level):

- AMA + DCR is the **modern** way (replaces old Log Analytics & Diagnostics agents).
- DCRs are separate Azure resources that can be assigned to:
  - Individual VMs
  - VM scale sets
  - Azure Arc servers
- You can **reuse one DCR for many machines**.
- You can **multi‑home** data (send to multiple workspaces) depending on configuration.

You typically configure DCRs through:
- **Azure portal**: e.g., VM → Insights → Enable.
- **ARM/Bicep**, **PowerShell**, **CLI**, or **Policy** for at‑scale deployment.

---

## 6. Enabling logs at scale with Azure Policy

You often need to ensure **every new resource** has logging enabled to a central workspace.

Azure Policy can:
- Audit resources without diagnostic settings.
- Deploy diagnostic settings automatically (**DeployIfNotExists** effect).
- Ensure compliance across subscriptions/management groups.

Example use cases:

- “All storage accounts must send logs to workspace X.”
- “All Key Vaults must have diagnostics enabled.”
- “All NSGs must send flow logs.”

**Exam hint:**  
If a question mentions:
- *“Automatically enforce diagnostic settings on all new resources”* → use **Azure Policy** with **DeployIfNotExists**.
- *“Check which resources do not have diagnostics enabled”* → use **Audit** policy.

---

## 7. Example configurations (exam‑style scenarios)

### Scenario 1 – Keep Activity log for 1 year and query it

> Requirement: Keep Activity log for 365 days and allow advanced querying and alerting.

Solution:
- Create a **Log Analytics workspace** with retention = 365 days.
- Configure **subscription Activity log diagnostic setting** to send logs to that workspace.

### Scenario 2 – Investigate who accessed a secret in Key Vault

> Requirement: Security team needs detailed access logs for Key Vault for 90 days.

Solution:
- On **Key Vault → Diagnostic settings**:
  - Enable `AuditEvent` logs.
  - Send to **Log Analytics workspace** with retention ≥ 90 days.
- Use KQL in Log Analytics to filter by Key Vault name, operation, and principal.

### Scenario 3 – Long‑term storage account logs for compliance

> Requirement: Store storage account logs for 7 years; queries are rare.

Solution:
- Configure **diagnostic settings** on the storage account to send logs to:
  - **Log Analytics workspace** with normal retention (e.g., 30–90 days) for recent analysis.
  - **Storage account** for long‑term archive (7 years).
- Optionally, use lifecycle rules on the archive storage.

### Scenario 4 – Force all NSGs to send flow logs

> Requirement: Your company wants traffic logs for all NSGs.

Solution:
- Use **Network Watcher NSG flow logs** (configured per NSG).
- Or, for exam‑style governance:
  - Use **Azure Policy** to audit or deploy configuration that enables NSG flow logs to a storage account and Log Analytics (with Traffic Analytics).

---

## 8. Best practices for log settings

1. **Plan workspaces**
   - Don’t create a new workspace for every resource.
   - Group by environment (Prod/Test/Dev) and/or region.

2. **Control costs**
   - Avoid sending noisy logs that you never use.
   - Use filters in DCRs and diagnostic settings where supported.
   - Monitor workspace usage and adjust retention.

3. **Use multiple destinations when needed**
   - Workspace for interactive analysis and alerts.
   - Storage for cheap, long‑term archive.
   - Event Hub for external systems.

4. **Automate**
   - Use **Azure Policy** and IaC (Bicep/ARM/Terraform) to ensure consistent logging.
   - Don’t rely on manually enabling diagnostics for each new resource.

5. **Secure log access**
   - Restrict access to workspaces and storage accounts.
   - Use RBAC and, for sensitive logs, private endpoints / networking restrictions.
   - Treat logs as sensitive data (they often contain IPs, user IDs, sometimes payloads).

---

## 9. Summary

To configure log settings in Azure Monitor, you must understand:

- **What** you want to log:
  - Activity log, resource logs, Entra ID logs, guest logs, app logs, etc.
- **Where** you want to store it:
  - Log Analytics workspace, storage account, Event Hub, or partner.
- **How** you configure it:
  - **Diagnostic settings** on resources, subscriptions, and Entra.
  - **Data Collection Rules** for AMA.
  - **Azure Policy** to enforce logging at scale.

If you can read an exam question and decide:
- which **log type**,  
- which **destination**, and  
- which **configuration method** (portal, diagnostic setting, policy),  

you’ll be able to handle most “Configure log settings in Azure Monitor” topics in AZ‑104.
